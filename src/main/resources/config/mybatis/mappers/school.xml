<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmc.edu.school">
    <cache type="org.mybatis.caches.ehcache.EhcacheCache"
           eviction="FIFO"
           flushInterval="60000"
           size="512"
           readOnly="true"
            />
    <sql id="limit-split-page">
        limit #{start}, #{size}
    </sql>
    <select id="querySchoolCount" parameterType="map" resultType="int">
        SELECT count(id)
        FROM school
        <where>
            `city_id` = #{cityId}
            <if test="key != null">
                and `name` LIKE CONCAT('%', #{key})
            </if>
        </where>

    </select>

    <select id="querySchoolPage" parameterType="map" resultType="map">
        SELECT id as schoolId, `name` as schoolName
        FROM school
        <where>
            `city_id` = #{cityId}
            <if test="key != null">
                and `name` LIKE CONCAT('%', #{key})
            </if>
        </where>

        <include refid="limit-split-page"/>
    </select>

    <select id="queryClassCount" parameterType="map" resultType="int">
        SELECT count(id)
        FROM class
        <where>
            `school_id` = #{schoolId}
            <if test="key != null">
                and (`grade` LIKE CONCAT('%', #{key}) or `class` LIKE CONCAT('%', #{key}))
            </if>
        </where>

    </select>

    <select id="queryClassPage" parameterType="map" resultType="map">
        SELECT id as classId, grade,class
        FROM class
        <where>
            `school_id` = #{schoolId}
            <if test="key != null">
                and (`grade` LIKE CONCAT('%', #{key}) or `class` LIKE CONCAT('%', #{key}))
            </if>
        </where>
        <include refid="limit-split-page"/>
    </select>

    <select id="queryHeadmaster" parameterType="map" resultType="map">
        SELECT p.id as headTeacherId, p.name as headTeacherName
        FROM profile p
        LEFT JOIN teacher t
        ON p.id = t.profile_id
        LEFT JOIN teacher_class_map tcm
        on t.profile_id = tcm.teacher_Id
        LEFT JOIN class c
        ON tcm.class_Id = c.id
        WHERE c.id = #{classId};
    </select>

    <insert id="initialStudent" useGeneratedKeys="true" keyProperty="id"
            parameterType="com.fmc.edu.model.student.Student">
        INSERT INTO student (name, class_id, sex, birth, ring_number, ring_phone, creation_date, last_update_date)
        VALUES (#{name}, #{classId}, #{male}, #{birth}, #{ringNumber}, #{ringPhone}, #{creationDate},
        #{lastUpdateDate})
    </insert>

    <select id="queryStudentIdByFields" parameterType="com.fmc.edu.model.student.Student" resultType="int">
        SELECT id
        FROM student
        WHERE NAME = #{name} AND class_id = #{classId}
    </select>

    <update id="updateStudentById" parameterType="com.fmc.edu.model.student.Student">
        UPDATE student
        SET name = #{name}, class_id = #{classId}, sex = #{male}, birth = #{birth}, ring_number = #{ringNumber},
        ring_phone = #{ringPhone}, last_update_date = #{lastUpdateDate}
        WHERE id = #{id}
    </update>

    <select id="queryTeacherById" parameterType="int" resultMap="teacher">
        SELECT id, `name`, phone, app_id, channel_id, creation_date, last_login_date, last_update_date, available, concat(profile_type,
        '') as profile_type,
        school_id, sex, head_teacher, initialized, resume, course, birth
        FROM profile
        LEFT JOIN teacher ON id = profile_id
        WHERE id = #{id}
    </select>

    <resultMap id="teacher" type="TeacherProfile">
        <id property="id" column="id" />
        <result property="name" column="name" />
        <result property="phone" column="phone" />
        <result property="appId" column="app_id" />
        <result property="channelId" column="channel_id" />
        <result property="creationDate" column="creation_date" />
        <result property="lastLoginDate" column="last_login_date" />
        <result property="lastUpdateDate" column="last_update_date" />
        <result property="available" column="available" />
        <result property="male" column="sex" />
        <result property="headTeacher" column="head_teacher" />
        <result property="initialized" column="initialized" />
        <result property="resume" column="resume" />
        <result property="course" column="course" />
        <result property="birth" column="birth" />
    </resultMap>
</mapper>